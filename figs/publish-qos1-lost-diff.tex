\begin{tikzpicture}
    \node[draw,circle,fill=DodgerBlue3!20]
        (pub1) at (0,0) {PUB};

    \node[draw,fill=yellow!20] (broker)
        at ($(pub1)+(7,0)$) {Broker};

    \draw
        (pub1)
        --
        ($(pub1.south)-(0,4.5)$)
        ;
    \draw
        (broker)
        --
        ($(broker.south)-(0,5)$)
        ;


    \draw[->]
        ($(pub1)-(0,1)$)
        --
        node[midway,above] {\texttt{PUBLISH,Pkt ID=15,DUP=0,`A'}}
        ($(broker)-(0,1)$)
        node[draw,anchor=west,circle,fill=OliveDrab3!20,
        inner sep=1]
        (ok1)
        {OK}
        ;

    \node[draw,anchor=west,fill=Firebrick4!20]
        at (ok1.east)
        {process};

    \draw[->]
        ($(broker)-(0,2)$)
        --
        node[midway,above] {\texttt{PUBACK,Pkt ID=15}}
        ($(pub1)-(0,2)$)
        ;

    \draw[->]
        ($(pub1)-(0,3)$)
        --
        node[midway,above] {\texttt{PUBLISH,Pkt ID=15,DUP=0,`B'}}
        ($(broker)-(1,3)$)
        node[anchor=west,Firebrick3]
        {\textbf{X}}
        ;

    \draw[->]
        ($(pub1)-(0,4)$)
        --
        node[midway,above] {\texttt{PUBLISH,Pkt ID=15,DUP=1,`B'}}
        ($(broker)-(0,4)$)
        node[draw,anchor=west,circle,fill=OliveDrab3!20,
        inner sep=1]
        (ok2)
        {OK}
        ;

    \node[draw,anchor=west,fill=Firebrick4!20]
        at (ok2.east)
        {process};

    \draw[->]
        ($(broker)-(0,5)$)
        --
        node[midway,above] {\texttt{PUBACK,Pkt ID=15}}
        ($(pub1)-(0,5)$)
        ;
\end{tikzpicture}
